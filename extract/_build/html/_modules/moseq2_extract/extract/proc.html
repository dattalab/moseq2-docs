
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>moseq2_extract.extract.proc &#8212; moseq2-extract  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for moseq2_extract.extract.proc</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">moseq2_extract.util</span> <span class="k">import</span> <span class="n">convert_pxs_to_mm</span><span class="p">,</span> <span class="n">strided_app</span>
<span class="kn">import</span> <span class="nn">moseq2_extract.io.video</span>
<span class="kn">import</span> <span class="nn">moseq2_extract.extract.roi</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">skimage.measure</span>
<span class="kn">import</span> <span class="nn">skimage.morphology</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">import</span> <span class="nn">joblib</span>


<div class="viewcode-block" id="get_flips"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.get_flips">[docs]</a><span class="k">def</span> <span class="nf">get_flips</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">flip_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Predict flips</span>
<span class="sd">    Args:</span>
<span class="sd">        frames (3d numpy array): frames x r x c, cropped mouse</span>
<span class="sd">        flip_file (string): path to joblib dump of scipy random forest classifier</span>
<span class="sd">        smoothing (int): kernel size for median filter smoothing of random forest probabilities</span>

<span class="sd">    Returns:</span>
<span class="sd">        flips (bool array):  true for flips</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">flip_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Could not open file </span><span class="si">{flip_file}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="n">flip_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">classes_</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">probas</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
        <span class="n">frames</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">smoothing</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">probas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">probas</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">medfilt</span><span class="p">(</span><span class="n">probas</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">smoothing</span><span class="p">)</span>

    <span class="n">flips</span> <span class="o">=</span> <span class="n">probas</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">flip_class</span>

    <span class="k">return</span> <span class="n">flips</span></div>


<div class="viewcode-block" id="get_largest_cc"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.get_largest_cc">[docs]</a><span class="k">def</span> <span class="nf">get_largest_cc</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns largest connected component blob in image</span>
<span class="sd">    Args:</span>
<span class="sd">        frame (3d numpy array): frames x r x c, uncropped mouse</span>
<span class="sd">        progress_bar (bool): display progress bar</span>

<span class="sd">    Returns:</span>
<span class="sd">        flips (3d bool array):  frames x r x c, true where blob was found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">foreground_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s1">&#39;bool&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress_bar</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;CC&#39;</span><span class="p">):</span>
        <span class="n">nb_components</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span>\
            <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponentsWithStats</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">szs</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">foreground_obj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span> <span class="o">==</span> <span class="n">szs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">foreground_obj</span></div>


<div class="viewcode-block" id="get_bground_im"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.get_bground_im">[docs]</a><span class="k">def</span> <span class="nf">get_bground_im</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns background</span>
<span class="sd">    Args:</span>
<span class="sd">        frames (3d numpy array): frames x r x c, uncropped mouse</span>

<span class="sd">    Returns:</span>
<span class="sd">        bground (2d numpy array):  r x c, background image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bground</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bground</span></div>


<div class="viewcode-block" id="get_bground_im_file"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.get_bground_im_file">[docs]</a><span class="k">def</span> <span class="nf">get_bground_im_file</span><span class="p">(</span><span class="n">frames_file</span><span class="p">,</span> <span class="n">frame_stride</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">med_scale</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns background from file</span>
<span class="sd">    Args:</span>
<span class="sd">        frames_file (path): path to data with frames</span>
<span class="sd">        frame_stride</span>

<span class="sd">    Returns:</span>
<span class="sd">        bground (2d numpy array):  r x c, background image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">frames_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;dat&#39;</span><span class="p">):</span>
        <span class="n">finfo</span> <span class="o">=</span> <span class="n">moseq2_extract</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">get_raw_info</span><span class="p">(</span><span class="n">frames_file</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">frames_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;avi&#39;</span><span class="p">):</span>
        <span class="n">finfo</span> <span class="o">=</span> <span class="n">moseq2_extract</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">get_video_info</span><span class="p">(</span><span class="n">frames_file</span><span class="p">)</span>

    <span class="n">frame_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">finfo</span><span class="p">[</span><span class="s1">&#39;nframes&#39;</span><span class="p">],</span> <span class="n">frame_stride</span><span class="p">)</span>
    <span class="n">frame_store</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">frame_idx</span><span class="p">),</span> <span class="n">finfo</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">finfo</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frame_idx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">frames_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;dat&#39;</span><span class="p">):</span>
            <span class="n">frs</span> <span class="o">=</span> <span class="n">moseq2_extract</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">read_frames_raw</span><span class="p">(</span><span class="n">frames_file</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">frames_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;avi&#39;</span><span class="p">):</span>
            <span class="n">frs</span> <span class="o">=</span> <span class="n">moseq2_extract</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">read_frames</span><span class="p">(</span><span class="n">frames_file</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="p">)])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">frame_store</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">medianBlur</span><span class="p">(</span><span class="n">frs</span><span class="p">,</span> <span class="n">med_scale</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">get_bground_im</span><span class="p">(</span><span class="n">frame_store</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_bbox"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.get_bbox">[docs]</a><span class="k">def</span> <span class="nf">get_bbox</span><span class="p">(</span><span class="n">roi</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a binary mask, return an array with the x and y boundaries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()],</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()]])</span>
        <span class="k">return</span> <span class="n">bbox</span></div>


<div class="viewcode-block" id="get_roi"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.get_roi">[docs]</a><span class="k">def</span> <span class="nf">get_roi</span><span class="p">(</span><span class="n">depth_image</span><span class="p">,</span>
            <span class="n">strel_dilate</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_RECT</span><span class="p">,</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">)),</span>
            <span class="n">strel_erode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">noise_tolerance</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">overlap_roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gradient_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">gradient_kernel</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
            <span class="n">gradient_threshold</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span>
            <span class="n">fill_holes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get an ROI using RANSAC plane fitting and simple blob features</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">gradient_filter</span><span class="p">:</span>
        <span class="n">gradient_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">depth_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span>
                                      <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="n">gradient_kernel</span><span class="p">))</span>
        <span class="n">gradient_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">depth_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span>
                                      <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="n">gradient_kernel</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">gradient_x</span> <span class="o">&lt;</span> <span class="n">gradient_threshold</span><span class="p">,</span> <span class="n">gradient_y</span> <span class="o">&lt;</span> <span class="n">gradient_threshold</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">roi_plane</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">moseq2_extract</span><span class="o">.</span><span class="n">extract</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">plane_ransac</span><span class="p">(</span>
        <span class="n">depth_image</span><span class="p">,</span> <span class="n">noise_tolerance</span><span class="o">=</span><span class="n">noise_tolerance</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">dist_ims</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">depth_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gradient_filter</span><span class="p">:</span>
        <span class="n">dist_ims</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="n">bin_im</span> <span class="o">=</span> <span class="n">dist_ims</span> <span class="o">&lt;</span> <span class="n">noise_tolerance</span>

    <span class="c1"># anything &lt; noise_tolerance from the plane is part of it</span>

    <span class="n">label_im</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">bin_im</span><span class="p">)</span>
    <span class="n">region_properties</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">label_im</span><span class="p">)</span>

    <span class="n">areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">region_properties</span><span class="p">),))</span>
    <span class="n">extents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">areas</span><span class="p">)</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">extents</span><span class="p">)</span>

    <span class="c1"># get the max distance from the center, area and extent</span>

    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depth_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">region_properties</span><span class="p">):</span>
        <span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">area</span>
        <span class="n">extents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">extent</span>
        <span class="n">tmp_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">coords</span><span class="o">-</span><span class="n">center</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_dists</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># rank features</span>

    <span class="n">ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="o">-</span><span class="n">areas</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">),</span>
                       <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="o">-</span><span class="n">extents</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">),</span>
                       <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)))</span>
    <span class="n">weight_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">shape_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ranks</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">weight_array</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

    <span class="c1"># expansion microscopy on the roi</span>

    <span class="n">rois</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">shape_index</span><span class="p">:</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">depth_image</span><span class="p">)</span>
        <span class="n">roi</span><span class="p">[</span><span class="n">region_properties</span><span class="p">[</span><span class="n">shape</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">region_properties</span><span class="p">[</span><span class="n">shape</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">strel_dilate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">strel_dilate</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strel_erode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">strel_erode</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fill_holes</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">binary_fill_holes</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>

        <span class="c1"># roi=skimage.morphology.dilation(roi,dilate_element)</span>
        <span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
        <span class="n">bboxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_bbox</span><span class="p">(</span><span class="n">roi</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">overlap_roi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">overlaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">areas</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rois</span><span class="p">)):</span>
            <span class="n">overlaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">overlap_roi</span><span class="p">,</span> <span class="n">rois</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="n">del_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">overlaps</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">rois</span><span class="p">[</span><span class="n">del_roi</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">bboxes</span><span class="p">[</span><span class="n">del_roi</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">rois</span><span class="p">,</span> <span class="n">roi_plane</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">label_im</span><span class="p">,</span> <span class="n">ranks</span><span class="p">,</span> <span class="n">shape_index</span></div>


<div class="viewcode-block" id="apply_roi"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.apply_roi">[docs]</a><span class="k">def</span> <span class="nf">apply_roi</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">roi</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply ROI to data, consider adding constraints (e.g. mod32==0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># yeah so fancy indexing slows us down by 3-5x</span>
    <span class="n">cropped_frames</span> <span class="o">=</span> <span class="n">frames</span><span class="o">*</span><span class="n">roi</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">get_bbox</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
    <span class="c1"># cropped_frames[:,roi==0]=0</span>
    <span class="n">cropped_frames</span> <span class="o">=</span> <span class="n">cropped_frames</span><span class="p">[:,</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">cropped_frames</span></div>


<div class="viewcode-block" id="im_moment_features"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.im_moment_features">[docs]</a><span class="k">def</span> <span class="nf">im_moment_features</span><span class="p">(</span><span class="n">IM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use the method of moments and centralized moments to get image properties</span>

<span class="sd">    Args:</span>
<span class="sd">        IM (2d numpy array): depth image</span>

<span class="sd">    Returns:</span>
<span class="sd">        Features (dictionary): returns a dictionary with orientation,</span>
<span class="sd">        centroid, and ellipse axis length</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">IM</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;mu11&#39;</span><span class="p">]</span>
    <span class="n">den</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;mu20&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;mu02&#39;</span><span class="p">]</span>

    <span class="n">common</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;mu11&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">den</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;m00&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s1">&#39;centroid&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s1">&#39;axis_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="o">-.</span><span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">),</span>
            <span class="s1">&#39;centroid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;m10&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;m00&#39;</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;m01&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;m00&#39;</span><span class="p">]],</span>
            <span class="s1">&#39;axis_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;mu20&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;mu02&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">common</span><span class="p">)</span><span class="o">/</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;m00&#39;</span><span class="p">]),</span>
                            <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;mu20&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;mu02&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">common</span><span class="p">)</span><span class="o">/</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;m00&#39;</span><span class="p">])]</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">features</span></div>


<div class="viewcode-block" id="clean_frames"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.clean_frames">[docs]</a><span class="k">def</span> <span class="nf">clean_frames</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">prefilter_space</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">prefilter_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">strel_tail</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)),</span>
                 <span class="n">iters_tail</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame_dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">,</span>
                 <span class="n">strel_min</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_RECT</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span>
                 <span class="n">iters_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple filtering, median filter and morphological opening</span>

<span class="sd">    Args:</span>
<span class="sd">        frames (3d np array): frames x r x c</span>
<span class="sd">        strel (opencv structuring element): strel for morph opening</span>
<span class="sd">        iters_tail (int): number of iterations to run opening</span>

<span class="sd">    Returns:</span>
<span class="sd">        filtered_frames (3d np array): frame x r x c</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># seeing enormous speed gains w/ opencv</span>
    <span class="n">filtered_frames</span> <span class="o">=</span> <span class="n">frames</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">frame_dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                       <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress_bar</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Cleaning frames&#39;</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">iters_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iters_min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">filtered_frames</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">filtered_frames</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">strel_min</span><span class="p">,</span> <span class="n">iters_min</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prefilter_space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prefilter_space</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prefilter_space</span><span class="p">)):</span>
                <span class="n">filtered_frames</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">medianBlur</span><span class="p">(</span><span class="n">filtered_frames</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">prefilter_space</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">iters_tail</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iters_tail</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">filtered_frames</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span>
                <span class="n">filtered_frames</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span> <span class="n">strel_tail</span><span class="p">,</span> <span class="n">iters_tail</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">prefilter_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prefilter_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prefilter_time</span><span class="p">)):</span>
            <span class="n">filtered_frames</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">medfilt</span><span class="p">(</span>
                <span class="n">filtered_frames</span><span class="p">,</span> <span class="p">[</span><span class="n">prefilter_time</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">filtered_frames</span></div>


<div class="viewcode-block" id="get_frame_features"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.get_frame_features">[docs]</a><span class="k">def</span> <span class="nf">get_frame_features</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">frame_threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
                       <span class="n">mask_threshold</span><span class="o">=-</span><span class="mi">30</span><span class="p">,</span> <span class="n">use_cc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use image moments to compute features of the largest object in the frame</span>

<span class="sd">    Args:</span>
<span class="sd">        frames (3d np array)</span>
<span class="sd">        frame_threshold (int): threshold in mm separating floor from mouse</span>

<span class="sd">    Returns:</span>
<span class="sd">        features (dict list): dictionary with simple image features</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nframes</span> <span class="o">=</span> <span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">has_mask</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">has_mask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;centroid&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nframes</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
        <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nframes</span><span class="p">,)),</span>
        <span class="s1">&#39;axis_length&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nframes</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">features</span><span class="p">[</span><span class="n">k</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nframes</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress_bar</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Computing moments&#39;</span><span class="p">):</span>

        <span class="n">frame_mask</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">frame_threshold</span>

        <span class="k">if</span> <span class="n">use_cc</span><span class="p">:</span>
            <span class="n">cc_mask</span> <span class="o">=</span> <span class="n">get_largest_cc</span><span class="p">((</span><span class="n">frames</span><span class="p">[[</span><span class="n">i</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mask_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">frame_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">cc_mask</span><span class="p">,</span> <span class="n">frame_mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_mask</span><span class="p">:</span>
            <span class="n">frame_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">frame_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mask_threshold</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame_mask</span>

        <span class="n">cnts</span><span class="p">,</span> <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
            <span class="n">frame_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">),</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_TREE</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cnts</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">tmp</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">mouse_cnt</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">im_moment_features</span><span class="p">(</span><span class="n">cnts</span><span class="p">[</span><span class="n">mouse_cnt</span><span class="p">])</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">features</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="crop_and_rotate_frames"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.crop_and_rotate_frames">[docs]</a><span class="k">def</span> <span class="nf">crop_and_rotate_frames</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span>
                           <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">nframes</span> <span class="o">=</span> <span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cropped_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">frames</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">win</span> <span class="o">=</span> <span class="p">(</span><span class="n">crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">border</span> <span class="o">=</span> <span class="p">(</span><span class="n">crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress_bar</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Rotating&#39;</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:])):</span>
            <span class="k">continue</span>

        <span class="c1"># use_frame = np.pad(frames[i, ...], (crop_size, crop_size), &#39;constant&#39;, constant_values=0)</span>
        <span class="n">use_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">*</span><span class="n">border</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                       <span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">)</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                       <span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">)</span>

        <span class="n">rr</span> <span class="o">=</span> <span class="n">rr</span><span class="o">+</span><span class="n">crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">+</span><span class="n">crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">rr</span> <span class="o">&gt;=</span> <span class="n">use_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">rr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cc</span> <span class="o">&gt;=</span> <span class="n">use_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cc</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="k">continue</span>

        <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getRotationMatrix2D</span><span class="p">((</span><span class="n">crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
                                          <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cropped_frames</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">use_frame</span><span class="p">[</span><span class="n">rr</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">rr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">cc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                                                 <span class="n">rot_mat</span><span class="p">,</span> <span class="p">(</span><span class="n">crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">cropped_frames</span></div>


<div class="viewcode-block" id="compute_scalars"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.compute_scalars">[docs]</a><span class="k">def</span> <span class="nf">compute_scalars</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">track_features</span><span class="p">,</span> <span class="n">min_height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">true_depth</span><span class="o">=</span><span class="mf">673.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes scalars</span>
<span class="sd">    Args:</span>
<span class="sd">    frames (3d numpy array): frames x r x c, uncropped mouse</span>
<span class="sd">    track_features (dictionary):  dictionary with tracking variables (centroid and orientation)</span>
<span class="sd">    min_height (float): minimum height of the mouse</span>
<span class="sd">    max_height (float): maximum height of the mouse</span>

<span class="sd">    Returns:</span>
<span class="sd">    features (dict): dictionary of scalars</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nframes</span> <span class="o">=</span> <span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;centroid_x_px&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;centroid_y_px&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;velocity_2d_px&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;velocity_3d_px&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;width_px&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;length_px&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;area_px&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,)),</span>
        <span class="s1">&#39;centroid_x_mm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;centroid_y_mm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;velocity_2d_mm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;velocity_3d_mm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;width_mm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;length_mm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;area_mm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,)),</span>
        <span class="s1">&#39;height_ave_mm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;angle&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,),</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="s1">&#39;velocity_theta&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,)),</span>
    <span class="p">}</span>

    <span class="n">centroid_mm</span> <span class="o">=</span> <span class="n">convert_pxs_to_mm</span><span class="p">(</span><span class="n">track_features</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">],</span> <span class="n">true_depth</span><span class="o">=</span><span class="n">true_depth</span><span class="p">)</span>
    <span class="n">centroid_mm_shift</span> <span class="o">=</span> <span class="n">convert_pxs_to_mm</span><span class="p">(</span><span class="n">track_features</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">true_depth</span><span class="o">=</span><span class="n">true_depth</span><span class="p">)</span>

    <span class="n">px_to_mm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">centroid_mm_shift</span> <span class="o">-</span> <span class="n">centroid_mm</span><span class="p">)</span>
    <span class="n">masked_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">frames</span> <span class="o">&gt;</span> <span class="n">min_height</span><span class="p">,</span> <span class="n">frames</span> <span class="o">&lt;</span> <span class="n">max_height</span><span class="p">)</span>

    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid_x_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">track_features</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid_y_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">track_features</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid_x_mm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid_mm</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid_y_mm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid_mm</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># based on the centroid of the mouse, get the mm_to_px conversion</span>

    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;width_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">track_features</span><span class="p">[</span><span class="s1">&#39;axis_length&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;length_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">track_features</span><span class="p">[</span><span class="s1">&#39;axis_length&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;area_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masked_frames</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;width_mm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;width_px&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">px_to_mm</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;length_mm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;length_px&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">px_to_mm</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;area_mm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;area_px&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">px_to_mm</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">track_features</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span>

    <span class="n">nmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masked_frames</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nframes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nmask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">features</span><span class="p">[</span><span class="s1">&#39;height_ave_mm&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="n">frames</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">masked_frames</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]])</span>

    <span class="n">vel_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid_x_px&#39;</span><span class="p">][:</span><span class="mi">1</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid_x_px&#39;</span><span class="p">])))</span>
    <span class="n">vel_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid_y_px&#39;</span><span class="p">][:</span><span class="mi">1</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid_y_px&#39;</span><span class="p">])))</span>
    <span class="n">vel_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;height_ave_mm&#39;</span><span class="p">][:</span><span class="mi">1</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;height_ave_mm&#39;</span><span class="p">])))</span>

    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;velocity_2d_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">vel_x</span><span class="p">,</span> <span class="n">vel_y</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;velocity_3d_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vel_x</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vel_y</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vel_z</span><span class="p">))</span>

    <span class="n">vel_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid_x_mm&#39;</span><span class="p">][:</span><span class="mi">1</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid_x_mm&#39;</span><span class="p">])))</span>
    <span class="n">vel_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid_y_mm&#39;</span><span class="p">][:</span><span class="mi">1</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid_y_mm&#39;</span><span class="p">])))</span>

    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;velocity_2d_mm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">vel_x</span><span class="p">,</span> <span class="n">vel_y</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;velocity_3d_mm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vel_x</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vel_y</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vel_z</span><span class="p">))</span>

    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;velocity_theta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">vel_y</span><span class="p">,</span> <span class="n">vel_x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">features</span></div>


<div class="viewcode-block" id="feature_hampel_filter"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.feature_hampel_filter">[docs]</a><span class="k">def</span> <span class="nf">feature_hampel_filter</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">centroid_hampel_span</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">centroid_hampel_sig</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                          <span class="n">angle_hampel_span</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">angle_hampel_sig</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">centroid_hampel_span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">centroid_hampel_span</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">padded_centroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">],</span>
                                  <span class="p">(((</span><span class="n">centroid_hampel_span</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">centroid_hampel_span</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)),</span>
                                   <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                                  <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">vws</span> <span class="o">=</span> <span class="n">strided_app</span><span class="p">(</span><span class="n">padded_centroids</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">centroid_hampel_span</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">vws</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vws</span> <span class="o">-</span> <span class="n">med</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">med</span><span class="p">)</span>
            <span class="n">fill_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vals</span> <span class="o">&gt;</span> <span class="n">med</span> <span class="o">+</span> <span class="n">centroid_hampel_sig</span> <span class="o">*</span> <span class="n">mad</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">features</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">][</span><span class="n">fill_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">med</span><span class="p">[</span><span class="n">fill_idx</span><span class="p">]</span>

        <span class="n">padded_orientation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">],</span>
                                    <span class="p">(</span><span class="n">angle_hampel_span</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">angle_hampel_span</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
                                    <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">angle_hampel_span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">angle_hampel_span</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">vws</span> <span class="o">=</span> <span class="n">strided_app</span><span class="p">(</span><span class="n">padded_orientation</span><span class="p">,</span> <span class="n">angle_hampel_span</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">vws</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vws</span> <span class="o">-</span> <span class="n">med</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">med</span><span class="p">)</span>
        <span class="n">fill_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vals</span> <span class="o">&gt;</span> <span class="n">med</span> <span class="o">+</span> <span class="n">angle_hampel_sig</span> <span class="o">*</span> <span class="n">mad</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">][</span><span class="n">fill_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">med</span><span class="p">[</span><span class="n">fill_idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">features</span></div>


<div class="viewcode-block" id="model_smoother"><a class="viewcode-back" href="../../../moseq2_extract.extract.html#moseq2_extract.extract.proc.model_smoother">[docs]</a><span class="k">def</span> <span class="nf">model_smoother</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">ll</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clips</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="o">-</span><span class="mi">125</span><span class="p">)):</span>

    <span class="k">if</span> <span class="n">ll</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">clips</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">clips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">clips</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">features</span>

    <span class="n">ave_ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ll</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ll_frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ll</span><span class="p">):</span>

        <span class="n">max_mu</span> <span class="o">=</span> <span class="n">clips</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">min_mu</span> <span class="o">=</span> <span class="n">clips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">smoother</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">smoother</span> <span class="o">-=</span> <span class="n">min_mu</span>
        <span class="n">smoother</span> <span class="o">/=</span> <span class="p">(</span><span class="n">max_mu</span> <span class="o">-</span> <span class="n">min_mu</span><span class="p">)</span>

        <span class="n">smoother</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">smoother</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ave_ll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">smoother</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">xvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nans</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ndims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">xvec</span><span class="p">[</span><span class="o">~</span><span class="n">nans</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]],</span> <span class="n">v</span><span class="p">[</span><span class="o">~</span><span class="n">nans</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span>
                                                   <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                    <span class="n">fill_vals</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">xvec</span><span class="p">[</span><span class="n">nans</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]])</span>
                    <span class="n">features</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">xvec</span><span class="p">[</span><span class="n">nans</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]],</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_vals</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">xvec</span><span class="p">[</span><span class="o">~</span><span class="n">nans</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="o">~</span><span class="n">nans</span><span class="p">],</span>
                                               <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                <span class="n">fill_vals</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">xvec</span><span class="p">[</span><span class="n">nans</span><span class="p">])</span>
                <span class="n">features</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">nans</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_vals</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ave_ll</span><span class="p">)):</span>
        <span class="n">smoother</span> <span class="o">=</span> <span class="n">ave_ll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">features</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">smoother</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">smoother</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ave_ll</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">smoother</span> <span class="o">=</span> <span class="n">ave_ll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">features</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">smoother</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">smoother</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">features</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">moseq2-extract</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../moseq2_extract.html">moseq2_extract package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Jeff Markowitz, Winthrop Gillis.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>